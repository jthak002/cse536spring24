import os
import pwd
import time

next_round = -1
with open('/home/moderator/log/nextround', 'r') as f:
    next_round = int(f.read()) - 1

log_file_name = f'/home/moderator/log/{next_round}.log'

def read_n_to_last_line(filename, n = 1):
    # print(f"Looking for file {filename}")
    """Returns the nth before last line of a file (n=1 gives last line)"""
    num_newlines = 0
    if not os.path.exists(filename):
        print(f"File {filename} not found")
        return ''
    with open(filename, 'rb') as f:
        try:
            f.seek(-2, os.SEEK_END)
            while num_newlines < n:
                f.seek(-2, os.SEEK_CUR)
                if f.read(1) == b'\n':
                    num_newlines += 1
        except OSError:
            f.seek(0)
        last_line = f.readline().decode()
    return last_line


while True:
    last_line = read_n_to_last_line(log_file_name, 1)

    # print(last_line)
    if "Werewolves" in last_line and "vote" in last_line:
        time_stamp = int(last_line.split(' ')[0][1:-1])
        for pty in os.listdir('/dev/pts'):
            # print(pty)
            pty_path = os.path.join('/dev/pts', pty)

            if os.path.exists(pty_path):
                try:
                    uid = os.stat(pty_path).st_uid
                    username = pwd.getpwuid(uid).pw_name
                    mod_time = os.stat(pty_path).st_mtime
                except KeyError:
                    username = "Unknown"
            if mod_time >= time_stamp:
                print(f"Username : {username}, PTY : {pty_path}, Modification Time : {mod_time}")

    time.sleep(0.1)